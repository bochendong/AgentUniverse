# å†…å®¹ä¼˜åŒ–æµç¨‹

æœ¬æ–‡æ¡£è¯¦ç»†æè¿°ç¬”è®°æœ¬å†…å®¹ä¼˜åŒ–çš„æµç¨‹ï¼Œé‡‡ç”¨**è¯„ä¼°ä¸ä¿®æ”¹åˆ†ç¦»**çš„æ–°æ¶æ„ã€‚

## ğŸ“‹ æµç¨‹æ¦‚è§ˆ

å†…å®¹ä¼˜åŒ–é‡‡ç”¨**è¯„ä¼°ä¸ä¿®æ”¹åˆ†ç¦»**çš„æ¶æ„ï¼š
- **è¯„ä¼°é˜¶æ®µ**ï¼š`ContentEvaluationAgent` è¯„ä¼°å†…å®¹è´¨é‡ï¼Œè¯†åˆ«å…·ä½“é—®é¢˜
- **ä¿®å¤é˜¶æ®µ**ï¼š`NotebookAgent` æ¥æ”¶è¯„ä¼°ç»“æœï¼Œå¹¶è¡Œè°ƒç”¨ `modify_by_id` ä¿®å¤é—®é¢˜

**æ ¸å¿ƒåŸåˆ™**ï¼š
- **åªä¿®æ”¹æœ‰é—®é¢˜çš„åœ°æ–¹**ï¼šä¸é‡å†™æ•´ä¸ª Sectionï¼Œåªä¿®å¤è¯†åˆ«å‡ºçš„é—®é¢˜
- **ç»Ÿä¸€ä½¿ç”¨ Modify Tools**ï¼šæ‰€æœ‰ä¿®æ”¹éƒ½é€šè¿‡ `modify_by_id` å·¥å…·
- **æ¶æ„ç»Ÿä¸€**ï¼šé€šè¿‡ NotebookAgent çš„å·¥å…·ç³»ç»Ÿç»Ÿä¸€å¤„ç†

## ğŸ¯ è§¦å‘ä½ç½®å’Œæ–¹å¼

### è§¦å‘ä½ç½®ï¼š**NotebookCreator åˆ›å»º NotebookAgent å**

### è§¦å‘è€…ï¼š**NotebookCreator**ï¼ˆåœ¨åˆ›å»ºå®Œæ‰€æœ‰ç« èŠ‚åï¼‰

### è¯¦ç»†æµç¨‹

```
NotebookCreator.create_all_sections()
    â†“
æ‰€æœ‰ç« èŠ‚åˆ›å»ºå®Œæˆ
    â†“
åˆ›å»º NotebookAgentï¼ˆåŒ…å«æ‰€æœ‰ç« èŠ‚ï¼‰
    â†“
åˆ›å»º ContentEvaluationAgent (Agent as Tool)
    â†“
ContentEvaluationAgent è¯„ä¼°æ‰€æœ‰ç« èŠ‚å†…å®¹
    â†“
è¿”å›é—®é¢˜åˆ—è¡¨ï¼š
{
  "section_1": {
    "exercise_1": "ç¼ºå°‘é€‰é¡¹ï¼Œéœ€è¦è¡¥å……4ä¸ªé€‰é¡¹",
    "proof_1": "æ­¥éª¤ä¸å®Œæ•´ï¼Œç¼ºå°‘ä¸­é—´è®¡ç®—è¿‡ç¨‹",
    "definition_1": "å®šä¹‰ä¸å¤Ÿæ¸…æ™°"
  },
  "section_2": {
    "example_1": "ç¼ºå°‘ç­”æ¡ˆ"
  }
}
    â†“
å‘é€è¯„ä¼°ç»“æœç»™ NotebookAgent (send_message)
    â†“
NotebookAgent æ¥æ”¶æ¶ˆæ¯ï¼Œè¯†åˆ«ä¸ºè¯„ä¼°ç»“æœ
    â†“
å¹¶è¡Œè°ƒç”¨ modify_by_id ä¿®å¤é—®é¢˜ï¼š
  - modify_by_id(content_id="exercise_1", operation_type="update", ...)
  - modify_by_id(content_id="proof_1", operation_type="update", ...)
  - modify_by_id(content_id="definition_1", operation_type="update", ...)
    â†“
æ‰€æœ‰é—®é¢˜ä¿®å¤å®Œæˆ
```

## ğŸ” è¯„ä¼°é˜¶æ®µ

### ContentEvaluationAgent (Agent as Tool)

- **ä½ç½®**ï¼š`backend/tools/agent_as_tools/evaluation_agents/ContentEvaluationAgent.py`
- **åŠŸèƒ½**ï¼šè¯„ä¼°ç« èŠ‚å†…å®¹çš„è´¨é‡ï¼Œè¯†åˆ«å…·ä½“é—®é¢˜
- **è¾“å…¥**ï¼š
  - `sections`ï¼šæ‰€æœ‰ç« èŠ‚çš„å­—å…¸
  - `outline`ï¼šç¬”è®°æœ¬å¤§çº²
- **è¾“å‡º**ï¼šé—®é¢˜åˆ—è¡¨ï¼ˆJSON æ ¼å¼ï¼‰

**è¯„ä¼°æ ‡å‡†**ï¼š
1. **ç»ƒä¹ é¢˜**ï¼šæ˜¯å¦æœ‰å®Œæ•´çš„é€‰é¡¹ã€ç­”æ¡ˆã€è§£é‡Š
2. **è¯æ˜**ï¼šæ˜¯å¦æœ‰è¯¦ç»†çš„æ­¥éª¤ã€å…¬å¼å¼•ç”¨ã€è®¡ç®—è¿‡ç¨‹
3. **å®šä¹‰**ï¼šæ˜¯å¦æ¸…æ™°ã€å‡†ç¡®
4. **ä¾‹å­**ï¼šæ˜¯å¦æœ‰å®Œæ•´çš„è§£ç­”
5. **é¢˜ç›®ç±»å‹**ï¼šæ˜¯å¦æ˜ç¡®æŒ‡å®šï¼ˆmultiple_choice/fill_blank/proof/short_answer/codeï¼‰

**è¾“å‡ºæ ¼å¼**ï¼š
```json
{
  "section_title_1": {
    "field_id_1": "é—®é¢˜æè¿°1",
    "field_id_2": "é—®é¢˜æè¿°2"
  },
  "section_title_2": {
    "field_id_3": "é—®é¢˜æè¿°3"
  }
}
```

**ç‰¹ç‚¹**ï¼š
- åªè¿”å›æœ‰é—®é¢˜çš„åœ°æ–¹
- å¦‚æœå†…å®¹å·²ç»å¾ˆå¥½ï¼Œä¸è¿”å›
- é—®é¢˜æè¿°è¦å…·ä½“ï¼Œä¾¿äºä¿®å¤

### ä»£ç ç¤ºä¾‹

```python
# åœ¨ NotebookCreator ä¸­
from backend.tools.agent_as_tools.evaluation_agents import ContentEvaluationAgent
from agents import Runner

# åˆ›å»ºè¯„ä¼° Agent
evaluation_agent = ContentEvaluationAgent(
    sections=notebook_agent.sections,
    outline=notebook_agent.outline
)

# è¯„ä¼°å†…å®¹
evaluation_result = await Runner.run(
    evaluation_agent,
    "è¯·è¯„ä¼°æ‰€æœ‰ç« èŠ‚å†…å®¹çš„è´¨é‡ï¼Œè¯†åˆ«å…·ä½“é—®é¢˜"
)

# è·å–é—®é¢˜åˆ—è¡¨
issues = evaluation_result.final_output

# å¦‚æœæœ‰é—®é¢˜ï¼Œå‘é€ç»™ NotebookAgent ä¿®å¤
if issues:
    await notebook_agent.receive_message(
        f"è¯„ä¼°å‘ç°ä»¥ä¸‹é—®é¢˜ï¼Œè¯·ä¿®å¤ï¼š\n{json.dumps(issues, ensure_ascii=False)}"
    )
```

## ğŸ”§ ä¿®å¤é˜¶æ®µ

### NotebookAgent æ¥æ”¶è¯„ä¼°ç»“æœ

**æ¶ˆæ¯æ ¼å¼**ï¼š
```
è¯„ä¼°å‘ç°ä»¥ä¸‹é—®é¢˜ï¼Œè¯·ä¿®å¤ï¼š
{
  "section_1": {
    "exercise_1": "ç¼ºå°‘é€‰é¡¹ï¼Œéœ€è¦è¡¥å……4ä¸ªé€‰é¡¹",
    "proof_1": "æ­¥éª¤ä¸å®Œæ•´ï¼Œç¼ºå°‘ä¸­é—´è®¡ç®—è¿‡ç¨‹"
  }
}
```

### NotebookAgent çš„ä¿®å¤æµç¨‹

```
NotebookAgent æ¥æ”¶è¯„ä¼°ç»“æœæ¶ˆæ¯
    â†“
è§£æé—®é¢˜åˆ—è¡¨
    â†“
å¯¹æ¯ä¸ªé—®é¢˜ï¼š
  1. è·å–å½“å‰å†…å®¹ (get_content_by_id)
  2. æ ¹æ®é—®é¢˜ç±»å‹é€‰æ‹© ModifyAgent
  3. è°ƒç”¨ ModifyAgent ç”Ÿæˆä¿®å¤åçš„å†…å®¹
  4. å¹¶è¡Œè°ƒç”¨ modify_by_id æ‰§è¡Œä¿®å¤
    â†“
æ‰€æœ‰é—®é¢˜ä¿®å¤å®Œæˆ
    â†“
è‡ªåŠ¨é‡æ–°ç”Ÿæˆ notes å¹¶åŒæ­¥ outline
    â†“
ä¿å­˜åˆ°æ•°æ®åº“
```

### ä¿®å¤å·¥å…·

#### `fix_content_issues` (Function Tool)

- **ä½ç½®**ï¼š`backend/tools/function_tools/notebook_content_tools.py`
- **è§¦å‘è€…**ï¼šNotebookAgent
- **åŠŸèƒ½**ï¼šæ ¹æ®è¯„ä¼°ç»“æœæ‰¹é‡ä¿®å¤å†…å®¹é—®é¢˜
- **å‚æ•°**ï¼š
  - `issues`ï¼šè¯„ä¼°ç»“æœï¼ˆJSON å­—ç¬¦ä¸²æ ¼å¼ï¼‰

**å·¥ä½œæµç¨‹**ï¼š
1. è§£æé—®é¢˜åˆ—è¡¨
2. å¯¹æ¯ä¸ªé—®é¢˜ï¼š
   - è·å–å½“å‰å†…å®¹ï¼ˆ`get_content_by_id`ï¼‰
   - æ ¹æ®é—®é¢˜ç±»å‹é€‰æ‹© ModifyAgent
   - è°ƒç”¨ ModifyAgent ç”Ÿæˆä¿®å¤åçš„å†…å®¹
   - è°ƒç”¨ `modify_by_id` æ‰§è¡Œä¿®å¤
3. å¹¶è¡Œå¤„ç†æ‰€æœ‰é—®é¢˜
4. è¿”å›ä¿®å¤ç»“æœ

### ä»£ç ç¤ºä¾‹

```python
# NotebookAgent ä½¿ç”¨ fix_content_issues
@function_tool
def fix_content_issues(issues: str) -> str:
    """æ ¹æ®è¯„ä¼°ç»“æœä¿®å¤å†…å®¹é—®é¢˜"""
    import json
    import asyncio
    
    # 1. è§£æé—®é¢˜åˆ—è¡¨
    issues_dict = json.loads(issues)
    
    # 2. å¹¶è¡Œä¿®å¤é—®é¢˜
    tasks = []
    for section_title, section_issues in issues_dict.items():
        for field_id, problem_description in section_issues.items():
            # è·å–å½“å‰å†…å®¹
            current_content = get_content_by_id(field_id)
            
            # æ ¹æ®é—®é¢˜ç±»å‹é€‰æ‹© ModifyAgent
            if "exercise" in field_id or "example" in field_id:
                modify_agent = ExerciseModifyAgent()
            elif "proof" in field_id:
                modify_agent = ProofModifyAgent()
            elif "definition" in field_id:
                modify_agent = DefinitionModifyAgent()
            else:
                continue
            
            # ç”Ÿæˆä¿®å¤åçš„å†…å®¹
            task = asyncio.create_task(
                fix_single_issue(
                    modify_agent,
                    current_content,
                    problem_description,
                    field_id
                )
            )
            tasks.append(task)
    
    # 3. ç­‰å¾…æ‰€æœ‰ä¿®å¤å®Œæˆ
    results = await asyncio.gather(*tasks)
    
    return f"å·²ä¿®å¤ {len(results)} ä¸ªé—®é¢˜"
```

## ğŸ“Š å®Œæ•´æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ NotebookCreator â”‚
â”‚ åˆ›å»ºæ‰€æœ‰ç« èŠ‚     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åˆ›å»º NotebookAgentâ”‚
â”‚ (åŒ…å«æ‰€æœ‰ç« èŠ‚)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ContentEvaluationâ”‚
â”‚ Agent            â”‚
â”‚ (Agent as Tool) â”‚
â”‚                 â”‚
â”‚ è¯„ä¼°æ‰€æœ‰ç« èŠ‚å†…å®¹ â”‚
â”‚ è¯†åˆ«å…·ä½“é—®é¢˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¿”å›é—®é¢˜åˆ—è¡¨     â”‚
â”‚ {                â”‚
â”‚   "section_1": { â”‚
â”‚     "field_1":   â”‚
â”‚     "é—®é¢˜æè¿°"    â”‚
â”‚   }              â”‚
â”‚ }                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ send_message     â”‚
â”‚ å‘é€ç»™ NotebookAgentâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ NotebookAgent   â”‚
â”‚                 â”‚
â”‚ 1. æ¥æ”¶è¯„ä¼°ç»“æœ  â”‚
â”‚ 2. è§£æé—®é¢˜åˆ—è¡¨  â”‚
â”‚ 3. è°ƒç”¨          â”‚
â”‚    fix_content_  â”‚
â”‚    issues        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                 â”‚
         â–¼                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ModifyAgent     â”‚  â”‚ ModifyAgent     â”‚
â”‚ (ç”Ÿæˆæ–°å†…å®¹)     â”‚  â”‚ (ç”Ÿæˆæ–°å†…å®¹)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                    â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ modify_by_id     â”‚
         â”‚ (å¹¶è¡Œæ‰§è¡Œä¿®æ”¹)   â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”‘ å…³é”®è¦ç‚¹

1. **è¯„ä¼°ä¸ä¿®æ”¹åˆ†ç¦»**ï¼šè¯„ä¼° Agent åªè¯†åˆ«é—®é¢˜ï¼Œä¸ä¿®æ”¹å†…å®¹
2. **åªä¿®æ”¹æœ‰é—®é¢˜çš„åœ°æ–¹**ï¼šä¸é‡å†™æ•´ä¸ª Sectionï¼Œåªä¿®å¤è¯†åˆ«å‡ºçš„é—®é¢˜
3. **ç»Ÿä¸€ä½¿ç”¨ Modify Tools**ï¼šæ‰€æœ‰ä¿®æ”¹éƒ½é€šè¿‡ `modify_by_id` å·¥å…·
4. **å¹¶è¡Œä¿®å¤**ï¼šå¤šä¸ªé—®é¢˜å¯ä»¥å¹¶è¡Œä¿®å¤ï¼Œæé«˜æ•ˆç‡
5. **æ¶æ„ç»Ÿä¸€**ï¼šé€šè¿‡ NotebookAgent çš„å·¥å…·ç³»ç»Ÿç»Ÿä¸€å¤„ç†
6. **è‡ªåŠ¨è§¦å‘**ï¼šåœ¨ NotebookAgent åˆ›å»ºåè‡ªåŠ¨æ‰§è¡Œè¯„ä¼°å’Œä¿®å¤

## ğŸ¯ åœ¨ç¬”è®°æœ¬åˆ›å»ºæµç¨‹ä¸­çš„ä½ç½®

```
ç”¨æˆ·ç¡®è®¤å¤§çº²
    â†“
MasterAgent.create_notebook
    â†“
NotebookCreationRouter é€‰æ‹©ç­–ç•¥
    â†“
NotebookCreator.create_all_sections
    â†“
å¯¹æ¯ä¸ªç« èŠ‚ï¼š
  SectionCreator.create_section
    â†“
  1. ç”Ÿæˆç« èŠ‚å†…å®¹
    â†“
  2. ç›´æ¥è¿”å› Sectionï¼ˆä¸åœ¨è¿™é‡Œä¼˜åŒ–ï¼‰
    â†“
æ‰€æœ‰ç« èŠ‚åˆ›å»ºå®Œæˆ
    â†“
åˆ›å»º NotebookAgent
    â†“
ã€è‡ªåŠ¨ä¼˜åŒ–ã€‘
ContentEvaluationAgent è¯„ä¼°å†…å®¹
    â†“
å‘é€é—®é¢˜åˆ—è¡¨ç»™ NotebookAgent
    â†“
NotebookAgent å¹¶è¡Œä¿®å¤é—®é¢˜
    â†“
ä¼˜åŒ–å®Œæˆ
```

## ğŸ› å¸¸è§é—®é¢˜

### Q: ä¼˜åŒ–æ˜¯è‡ªåŠ¨æ‰§è¡Œçš„å—ï¼Ÿ
A: æ˜¯çš„ï¼Œåœ¨ `NotebookCreator` åˆ›å»º NotebookAgent åï¼Œä¼šè‡ªåŠ¨åˆ›å»º `ContentEvaluationAgent` è¯„ä¼°å†…å®¹ï¼Œç„¶åå‘é€é—®é¢˜åˆ—è¡¨ç»™ NotebookAgent ä¿®å¤ã€‚

### Q: ä¸ºä»€ä¹ˆä¸åœ¨ SectionCreator ä¸­ä¼˜åŒ–ï¼Ÿ
A: å› ä¸ºï¼š
1. é¿å…é‡å¤é€»è¾‘ï¼šç»Ÿä¸€ä½¿ç”¨ Modify Tools
2. æé«˜æ•ˆç‡ï¼šåªä¿®æ”¹æœ‰é—®é¢˜çš„åœ°æ–¹ï¼Œä¸å…¨éƒ¨é‡å†™
3. æ¶æ„ç»Ÿä¸€ï¼šé€šè¿‡ NotebookAgent çš„å·¥å…·ç³»ç»Ÿç»Ÿä¸€å¤„ç†

### Q: å¯ä»¥æ‰‹åŠ¨è§¦å‘è¯„ä¼°å—ï¼Ÿ
A: å¯ä»¥ï¼Œç›´æ¥åˆ›å»º `ContentEvaluationAgent` å¹¶è¿è¡Œï¼š
```python
evaluation_agent = ContentEvaluationAgent(sections, outline)
result = await Runner.run(evaluation_agent, "è¯„ä¼°å†…å®¹")
issues = result.final_output
```

### Q: å¦‚ä½•æ·»åŠ æ–°çš„è¯„ä¼°æ ‡å‡†ï¼Ÿ
A: åœ¨ `ContentEvaluationAgent` çš„ instructions ä¸­æ·»åŠ æ–°çš„è¯„ä¼°æ ‡å‡†ã€‚

### Q: ä¿®å¤å¤±è´¥æ€ä¹ˆåŠï¼Ÿ
A: ä¿®å¤å¤±è´¥æ—¶ä¼šè®°å½•é”™è¯¯ï¼Œä½†ä¸ä¼šä¸­æ–­å…¶ä»–é—®é¢˜çš„ä¿®å¤ã€‚å¯ä»¥æŸ¥çœ‹æ—¥å¿—äº†è§£å…·ä½“å¤±è´¥åŸå› ã€‚

### Q: è¯„ä¼°ä¼šå½±å“æ€§èƒ½å—ï¼Ÿ
A: è¯„ä¼°æ˜¯è½»é‡çº§çš„ï¼Œåªè¯†åˆ«é—®é¢˜ä¸ä¿®æ”¹å†…å®¹ã€‚ä¿®å¤æ˜¯å¹¶è¡Œæ‰§è¡Œçš„ï¼Œæ•ˆç‡è¾ƒé«˜ã€‚
