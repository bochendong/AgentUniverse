# è®¾è®¡é—®é¢˜ä¸é‡æ„æ–¹æ¡ˆ

æœ¬æ–‡æ¡£åˆ†æå½“å‰ç¬”è®°æœ¬åˆ›å»ºæµç¨‹çš„è®¾è®¡é—®é¢˜ï¼Œå¹¶æå‡ºç»Ÿä¸€çš„é‡æ„æ–¹æ¡ˆã€‚

## ğŸ”´ å½“å‰è®¾è®¡é—®é¢˜

### 1. åŠŸèƒ½é‡å¤ï¼š`intent_extraction_agent` å’Œ `NotebookCreationStrategies`

**é—®é¢˜æè¿°**ï¼š
- `intent_extraction_agent` åˆ†æç”¨æˆ·æ„å›¾ï¼Œè¿”å› `NotebookCreationIntent`
- `NotebookCreationStrategies` æ ¹æ®æ„å›¾é€‰æ‹©åˆ›å»ºç­–ç•¥
- ä¸¤è€…éƒ½åœ¨åˆ¤æ–­åˆ›å»ºæ„å›¾ï¼Œé€»è¾‘é‡å¤

**å½±å“**ï¼š
- ç»´æŠ¤æˆæœ¬é«˜ï¼šéœ€è¦åŒæ—¶ç»´æŠ¤ä¸¤å¥—åˆ¤æ–­é€»è¾‘
- å®¹æ˜“ä¸ä¸€è‡´ï¼šä¸¤å¤„åˆ¤æ–­å¯èƒ½äº§ç”Ÿä¸åŒç»“æœ
- å¢åŠ å¤æ‚åº¦ï¼šä¸å¿…è¦çš„ä¸­é—´å±‚

### 2. å‘½åæ··ä¹±ï¼š`create_notebook_from_outline` vs `create_notebook_with_outline`

**é—®é¢˜æè¿°**ï¼š
- `create_notebook_from_outline` (TopLevelAgent) å†…éƒ¨è°ƒç”¨ `create_notebook_with_outline` (MasterAgent)
- æ‰€æœ‰åˆ›å»ºéƒ½æ˜¯ä» outline åˆ›å»ºçš„ï¼Œè¿™ä¸¤ä¸ªåå­—æ²¡æœ‰åŒºåˆ«æ„ä¹‰
- å‘½åä¸ä¸€è‡´ï¼Œå®¹æ˜“æ··æ·†

**å½±å“**ï¼š
- å¼€å‘è€…å›°æƒ‘ï¼šä¸çŸ¥é“åº”è¯¥ç”¨å“ªä¸ª
- ä»£ç å¯è¯»æ€§å·®ï¼šåå­—ä¸èƒ½æ¸…æ™°è¡¨è¾¾åŠŸèƒ½

### 3. èŒè´£ä¸æ¸…ï¼š`generate_outline` vs `outline_maker_agent`

**é—®é¢˜æè¿°**ï¼š
- `generate_outline` æ˜¯ TopLevelAgent çš„ Function Tool
- `outline_maker_agent` æ˜¯ Agent as Tool
- `generate_outline` å†…éƒ¨è°ƒç”¨ `outline_maker_agent`
- ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªä¸­é—´å±‚ï¼Ÿ

**å½±å“**ï¼š
- ä¸å¿…è¦çš„å°è£…ï¼šå¢åŠ äº†è°ƒç”¨é“¾é•¿åº¦
- èŒè´£ä¸æ¸…ï¼š`generate_outline` åªæ˜¯ç®€å•åŒ…è£…

### 4. æ¶æ„ä¸ä¸€è‡´ï¼šä¸ºä»€ä¹ˆä¸ç›´æ¥ç”¨ `send_message`ï¼Ÿ

**é—®é¢˜æè¿°**ï¼š
- TopLevelAgent ç”Ÿæˆå¤§çº²åï¼Œåº”è¯¥ `send_message` ç»™ MasterAgent
- ä½†å½“å‰å®ç°æ˜¯ `create_notebook_from_outline` ç›´æ¥è°ƒç”¨ MasterAgent çš„å·¥å…·
- è¿åäº†å±‚çº§æ¶æ„çš„è®¾è®¡åŸåˆ™

**å½±å“**ï¼š
- æ¶æ„ä¸ä¸€è‡´ï¼šTopLevelAgent ç›´æ¥æ“ä½œ MasterAgent çš„å†…éƒ¨å·¥å…·
- è€¦åˆåº¦é«˜ï¼šTopLevelAgent éœ€è¦çŸ¥é“ MasterAgent çš„å·¥å…·ç»†èŠ‚

## âœ… ç»Ÿä¸€çš„é‡æ„æ–¹æ¡ˆ

### æ ¸å¿ƒåŸåˆ™

1. **ç»Ÿä¸€çš„åˆ›å»ºæµç¨‹**ï¼šæ‰€æœ‰åˆ›å»ºéƒ½æ˜¯ `generate_outline` â†’ ç”¨æˆ·ç¡®è®¤ â†’ `create_notebook`
2. **ä¸¤ç§ generate_outline**ï¼šæœ‰æ–‡ä»¶çš„å’Œæ— æ–‡ä»¶çš„
3. **å±‚çº§é€šä¿¡**ï¼šTopLevelAgent â†’ MasterAgent ä½¿ç”¨ `send_message`
4. **ç®€åŒ–å·¥å…·**ï¼šç§»é™¤ä¸å¿…è¦çš„ä¸­é—´å±‚å’Œé‡å¤é€»è¾‘

### é‡æ„åçš„æ¶æ„

```
ç”¨æˆ·è¯·æ±‚åˆ›å»ºç¬”è®°æœ¬
    â†“
TopLevelAgent.generate_outline (Function Tool)
    â”œâ”€ æœ‰æ–‡ä»¶ â†’ è°ƒç”¨ outline_maker_agent (Agent as Tool, ä¼ å…¥ file_path)
    â””â”€ æ— æ–‡ä»¶ â†’ è°ƒç”¨ outline_maker_agent (Agent as Tool, æ—  file_path)
    â†“
è¿”å›å¤§çº²ç»™ç”¨æˆ·ç¡®è®¤
    â†“
ç”¨æˆ·ç¡®è®¤
    â†“
TopLevelAgent.send_message (Function Tool)
    â†“
MasterAgent æ¥æ”¶æ¶ˆæ¯ï¼Œè°ƒç”¨ create_notebook (Function Tool)
    â†“
MasterAgent.create_notebook å†…éƒ¨ï¼š
    1. ä½¿ç”¨ NotebookCreationRouter é€‰æ‹©ç­–ç•¥
    2. NotebookCreationRouter å†…éƒ¨åˆ¤æ–­æ„å›¾ï¼ˆç§»é™¤ intent_extraction_agentï¼‰
    3. è°ƒç”¨å¯¹åº”çš„åˆ›å»ºç­–ç•¥
    4. åˆ›å»º NotebookAgent
    â†“
è¿”å›åˆ›å»ºç»“æœ
```

### è¯¦ç»†è®¾è®¡

#### 1. TopLevelAgent çš„å·¥å…·

**ä¿ç•™**ï¼š
- `generate_outline(user_request: str, file_path: str = None)` - ç»Ÿä¸€çš„å¤§çº²ç”Ÿæˆå·¥å…·
  - æœ‰æ–‡ä»¶ï¼šè°ƒç”¨ `outline_maker_agent` (Agent as Tool, ä¼ å…¥ file_path)
  - æ— æ–‡ä»¶ï¼šè°ƒç”¨ `outline_maker_agent` (Agent as Tool, æ—  file_path)
- `send_message(id: str, message: str)` - Agent é—´é€šä¿¡

**ç§»é™¤**ï¼š
- `handle_file_upload` - åŠŸèƒ½åˆå¹¶åˆ° `generate_outline`
- `create_notebook_from_outline` - æ”¹ç”¨ `send_message`

#### 2. MasterAgent çš„å·¥å…·

**ä¿ç•™**ï¼š
- `create_notebook(outline: str, file_path: str, user_request: str)` - ç»Ÿä¸€çš„åˆ›å»ºå·¥å…·
  - å†…éƒ¨ä½¿ç”¨ `NotebookCreationRouter` é€‰æ‹©ç­–ç•¥
  - ä¸å†éœ€è¦ `create_notebook_with_outline` è¿™ä¸ªåå­—

**ç§»é™¤**ï¼š
- `create_notebook_with_outline` - é‡å‘½åä¸º `create_notebook`
- `create_notebook` (æ—§çš„) - åŠŸèƒ½åˆå¹¶

#### 3. ç§»é™¤ `intent_extraction_agent`

**åŸå› **ï¼š
- æ„å›¾åˆ¤æ–­é€»è¾‘ç§»åˆ° `NotebookCreationRouter` å†…éƒ¨
- å‡å°‘ä¸å¿…è¦çš„ Agent è°ƒç”¨
- ç®€åŒ–æ¶æ„

**å®ç°**ï¼š
- `NotebookCreationRouter.route_and_create()` å†…éƒ¨åˆ¤æ–­æ„å›¾
- æ ¹æ®æ–‡ä»¶è·¯å¾„ã€ç”¨æˆ·è¯·æ±‚ã€æ–‡ä»¶å†…å®¹è‡ªåŠ¨é€‰æ‹©ç­–ç•¥

#### 4. ç®€åŒ– `generate_outline`

**å½“å‰**ï¼š
```python
generate_outline (Function Tool)
  â†’ generate_outline_for_confirmation (å‡½æ•°)
    â†’ NotebookCreationRouter.generate_outline
      â†’ outline_maker_agent (Agent as Tool)
```

**é‡æ„å**ï¼š
```python
generate_outline (Function Tool)
  â†’ outline_maker_agent (Agent as Tool, ç›´æ¥è°ƒç”¨)
```

**å¥½å¤„**ï¼š
- å‡å°‘ä¸­é—´å±‚
- èŒè´£æ¸…æ™°ï¼š`generate_outline` å°±æ˜¯è°ƒç”¨ `outline_maker_agent`

## ğŸ“‹ é‡æ„æ­¥éª¤

### é˜¶æ®µä¸€ï¼šç»Ÿä¸€å¤§çº²ç”Ÿæˆ

1. **ç®€åŒ– `generate_outline`**
   - ç›´æ¥è°ƒç”¨ `outline_maker_agent`
   - æ”¯æŒæœ‰æ–‡ä»¶å’Œæ— æ–‡ä»¶ä¸¤ç§åœºæ™¯
   - ç§»é™¤ `generate_outline_for_confirmation` ä¸­é—´å‡½æ•°

2. **ç§»é™¤ `handle_file_upload`**
   - åŠŸèƒ½åˆå¹¶åˆ° `generate_outline`
   - æ›´æ–° TopLevelAgent çš„ prompt

### é˜¶æ®µäºŒï¼šç»Ÿä¸€åˆ›å»ºæµç¨‹

1. **é‡å‘½å `create_notebook_with_outline` â†’ `create_notebook`**
   - ç»Ÿä¸€å‘½åï¼šæ‰€æœ‰åˆ›å»ºéƒ½æ˜¯ä» outline åˆ›å»ºçš„
   - æ›´æ–° MasterAgent çš„å·¥å…·åˆ—è¡¨

2. **ç§»é™¤ `create_notebook_from_outline`**
   - TopLevelAgent ä½¿ç”¨ `send_message` å‘é€ç»™ MasterAgent
   - æ¶ˆæ¯æ ¼å¼ï¼šåŒ…å« outline JSONã€file_pathã€user_request

3. **æ›´æ–° MasterAgent çš„æ¶ˆæ¯å¤„ç†**
   - è¯†åˆ«åˆ›å»ºç¬”è®°æœ¬çš„æ¶ˆæ¯
   - æå– outlineã€file_pathã€user_request
   - è°ƒç”¨ `create_notebook` å·¥å…·

### é˜¶æ®µä¸‰ï¼šç®€åŒ–æ„å›¾åˆ¤æ–­

1. **ç§»é™¤ `intent_extraction_agent`**
   - ä»å·¥å…·æ³¨å†Œè¡¨ä¸­ç§»é™¤
   - ä»æ•°æ®åº“ç§»é™¤ç›¸å…³è®°å½•

2. **åœ¨ `NotebookCreationRouter` å†…éƒ¨åˆ¤æ–­æ„å›¾**
   - `route_and_create()` æ–¹æ³•å†…éƒ¨åˆ¤æ–­
   - æ ¹æ®æ–‡ä»¶è·¯å¾„ã€ç”¨æˆ·è¯·æ±‚ã€æ–‡ä»¶å†…å®¹é€‰æ‹©ç­–ç•¥
   - ä¸å†éœ€è¦ `NotebookCreationIntent` å¯¹è±¡

3. **ç®€åŒ– `NotebookCreationStrategies`**
   - ç›´æ¥è°ƒç”¨ï¼Œä¸éœ€è¦å…ˆè·å–æ„å›¾
   - ç­–ç•¥é€‰æ‹©é€»è¾‘ç§»åˆ° `NotebookCreationRouter`

## ğŸ¯ é‡æ„åçš„å·¥å…·åˆ—è¡¨

### TopLevelAgent

| å·¥å…· ID | åŠŸèƒ½ | ç±»å‹ |
|---------|------|------|
| `generate_outline` | ç”Ÿæˆå¤§çº²ï¼ˆæœ‰æ–‡ä»¶/æ— æ–‡ä»¶ï¼‰ | Function Tool |
| `send_message` | Agent é—´é€šä¿¡ | Function Tool |

### MasterAgent

| å·¥å…· ID | åŠŸèƒ½ | ç±»å‹ |
|---------|------|------|
| `create_notebook` | æ ¹æ®å¤§çº²åˆ›å»ºç¬”è®°æœ¬ | Function Tool |
| `send_message` | Agent é—´é€šä¿¡ | Function Tool |

### Agent as Tool

| å·¥å…· ID | åŠŸèƒ½ | ä½¿ç”¨åœºæ™¯ |
|---------|------|----------|
| `outline_maker_agent` | ç”Ÿæˆå¤§çº² | TopLevelAgent.generate_outline |
| `outline_revision_agent` | ä¿®è®¢å¤§çº² | TopLevelAgentï¼ˆç”¨æˆ·è¦æ±‚ä¿®æ”¹å¤§çº²æ—¶ï¼‰ |

## ğŸ”„ é‡æ„åçš„å®Œæ•´æµç¨‹

### åœºæ™¯ä¸€ï¼šä»æ–‡ä»¶åˆ›å»º

```
1. ç”¨æˆ·ä¸Šä¼ æ–‡ä»¶ + è¯·æ±‚
   â†“
2. TopLevelAgent.generate_outline(user_request, file_path)
   â†’ è°ƒç”¨ outline_maker_agent (Agent as Tool, file_path)
   â†’ è¿”å›å¤§çº²
   â†“
3. ç”¨æˆ·ç¡®è®¤å¤§çº²
   â†“
4. TopLevelAgent.send_message(master_agent_id, message)
   message = {
     "action": "create_notebook",
     "outline": {...},
     "file_path": "...",
     "user_request": "..."
   }
   â†“
5. MasterAgent æ¥æ”¶æ¶ˆæ¯ï¼Œè¯†åˆ« action="create_notebook"
   â†’ è°ƒç”¨ create_notebook(outline, file_path, user_request)
   â†’ NotebookCreationRouter å†…éƒ¨åˆ¤æ–­æ„å›¾
   â†’ é€‰æ‹©ç­–ç•¥å¹¶åˆ›å»º
   â†“
6. è¿”å›åˆ›å»ºç»“æœ
```

### åœºæ™¯äºŒï¼šä»ä¸»é¢˜åˆ›å»º

```
1. ç”¨æˆ·è¯·æ±‚ï¼ˆæ— æ–‡ä»¶ï¼‰
   â†“
2. TopLevelAgent.generate_outline(user_request)
   â†’ è°ƒç”¨ outline_maker_agent (Agent as Tool, æ—  file_path)
   â†’ è¿”å›å¤§çº²
   â†“
3. ç”¨æˆ·ç¡®è®¤å¤§çº²
   â†“
4. TopLevelAgent.send_message(master_agent_id, message)
   message = {
     "action": "create_notebook",
     "outline": {...},
     "file_path": null,
     "user_request": "..."
   }
   â†“
5. MasterAgent æ¥æ”¶æ¶ˆæ¯ï¼Œè¯†åˆ« action="create_notebook"
   â†’ è°ƒç”¨ create_notebook(outline, null, user_request)
   â†’ NotebookCreationRouter åˆ¤æ–­ä¸º outline_first ç­–ç•¥
   â†’ åˆ›å»ºç¬”è®°æœ¬
   â†“
6. è¿”å›åˆ›å»ºç»“æœ
```

## ğŸ’¡ é‡æ„çš„å¥½å¤„

1. **æ¶æ„æ¸…æ™°**ï¼šéµå¾ªå±‚çº§ç»“æ„ï¼ŒTopLevelAgent â†’ MasterAgent ä½¿ç”¨ `send_message`
2. **èŒè´£æ˜ç¡®**ï¼šæ¯ä¸ªå·¥å…·èŒè´£å•ä¸€ï¼Œä¸é‡å¤
3. **å‘½åç»Ÿä¸€**ï¼šæ‰€æœ‰åˆ›å»ºéƒ½å« `create_notebook`ï¼Œä» outline åˆ›å»º
4. **å‡å°‘å¤æ‚åº¦**ï¼šç§»é™¤ä¸å¿…è¦çš„ä¸­é—´å±‚å’Œé‡å¤é€»è¾‘
5. **æ˜“äºç»´æŠ¤**ï¼šé€»è¾‘é›†ä¸­ï¼Œä¿®æ”¹å½±å“èŒƒå›´å°

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **æ•°æ®åº“è¿ç§»**ï¼šæ›´æ–°å·¥å…·æ³¨å†Œè¡¨ï¼Œåˆ é™¤æ—§å·¥å…·çš„è®°å½•
2. **Prompt æ›´æ–°**ï¼šæ›´æ–° TopLevelAgent å’Œ MasterAgent çš„ prompt
3. **ä»£ç æ¸…ç†**ï¼šç›´æ¥åˆ é™¤æ—§å·¥å…·çš„å®ç°ä»£ç ï¼Œä¸éœ€è¦ä¿ç•™
4. **æµ‹è¯•**ï¼šç¡®ä¿æ‰€æœ‰åœºæ™¯éƒ½èƒ½æ­£å¸¸å·¥ä½œ

## ğŸ“ å®æ–½æ­¥éª¤

### æ­¥éª¤ 1ï¼šç®€åŒ–å¤§çº²ç”Ÿæˆï¼ˆTopLevelAgentï¼‰

1. **ä¿®æ”¹ `generate_outline` å·¥å…·**
   - ç›´æ¥è°ƒç”¨ `outline_maker_agent`ï¼Œç§»é™¤ä¸­é—´å‡½æ•°
   - æ”¯æŒæœ‰æ–‡ä»¶å’Œæ— æ–‡ä»¶ä¸¤ç§åœºæ™¯
   - åˆ é™¤ `generate_outline_for_confirmation` å‡½æ•°

2. **åˆ é™¤ `handle_file_upload` å·¥å…·**
   - åŠŸèƒ½å·²åˆå¹¶åˆ° `generate_outline`
   - ä»å·¥å…·æ³¨å†Œè¡¨ä¸­ç§»é™¤

3. **æ›´æ–° TopLevelAgent çš„ prompt**
   - ç§»é™¤ `handle_file_upload` çš„è¯´æ˜
   - æ›´æ–° `generate_outline` çš„ä½¿ç”¨è¯´æ˜

### æ­¥éª¤ 2ï¼šç»Ÿä¸€åˆ›å»ºæµç¨‹ï¼ˆMasterAgentï¼‰

1. **é‡å‘½åå·¥å…·**
   - `create_notebook_with_outline` â†’ `create_notebook`
   - æ›´æ–°å·¥å…·æ³¨å†Œè¡¨

2. **åˆ é™¤ `create_notebook_from_outline` å·¥å…·**
   - TopLevelAgent æ”¹ç”¨ `send_message`
   - ä»å·¥å…·æ³¨å†Œè¡¨ä¸­ç§»é™¤

3. **æ›´æ–° MasterAgent çš„æ¶ˆæ¯å¤„ç†**
   - è¯†åˆ« `action="create_notebook"` çš„æ¶ˆæ¯
   - æå– outlineã€file_pathã€user_request
   - è°ƒç”¨ `create_notebook` å·¥å…·

4. **æ›´æ–° TopLevelAgent çš„ prompt**
   - ç§»é™¤ `create_notebook_from_outline` çš„è¯´æ˜
   - æ·»åŠ ä½¿ç”¨ `send_message` åˆ›å»ºç¬”è®°æœ¬çš„è¯´æ˜

### æ­¥éª¤ 3ï¼šç®€åŒ–æ„å›¾åˆ¤æ–­

1. **åˆ é™¤ `intent_extraction_agent`**
   - ä»å·¥å…·æ³¨å†Œè¡¨ä¸­ç§»é™¤
   - ä» `register_specialized_agents.py` ä¸­åˆ é™¤æ³¨å†Œä»£ç 
   - åˆ é™¤ `IntentExtractionAgent.py` æ–‡ä»¶

2. **ä¿®æ”¹ `NotebookCreationRouter`**
   - åœ¨ `route_and_create()` æ–¹æ³•å†…éƒ¨åˆ¤æ–­æ„å›¾
   - æ ¹æ®æ–‡ä»¶è·¯å¾„ã€ç”¨æˆ·è¯·æ±‚ã€æ–‡ä»¶å†…å®¹é€‰æ‹©ç­–ç•¥
   - ä¸å†éœ€è¦ `NotebookCreationIntent` å¯¹è±¡

3. **ç®€åŒ– `NotebookCreationStrategies`**
   - ç›´æ¥è°ƒç”¨ï¼Œä¸éœ€è¦å…ˆè·å–æ„å›¾
   - ç­–ç•¥é€‰æ‹©é€»è¾‘ç§»åˆ° `NotebookCreationRouter`

4. **æ›´æ–°æ•°æ®åº“**
   - åˆ é™¤ `intent_extraction_agent` çš„è®°å½•
   - æ›´æ–°ç›¸å…³å·¥å…·çš„ä¾èµ–å…³ç³»

### æ­¥éª¤ 4ï¼šæ¸…ç†å’Œæµ‹è¯•

1. **ä»£ç æ¸…ç†**
   - åˆ é™¤æ‰€æœ‰æœªä½¿ç”¨çš„å¯¼å…¥
   - åˆ é™¤æœªä½¿ç”¨çš„å‡½æ•°å’Œç±»
   - æ›´æ–°ç›¸å…³æ³¨é‡Š

2. **å…¨é¢æµ‹è¯•**
   - æµ‹è¯•ä»æ–‡ä»¶åˆ›å»ºç¬”è®°æœ¬
   - æµ‹è¯•ä»ä¸»é¢˜åˆ›å»ºç¬”è®°æœ¬
   - æµ‹è¯•å¤§çº²ä¿®è®¢æµç¨‹
   - æµ‹è¯•æ‰€æœ‰åˆ›å»ºç­–ç•¥ï¼ˆfull_contentã€enhancementã€knowledge_baseã€outline_firstï¼‰

