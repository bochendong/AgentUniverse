# å†…å®¹ä¼˜åŒ–é‡æ„æ–¹æ¡ˆ

æœ¬æ–‡æ¡£æå‡ºå†…å®¹ä¼˜åŒ–çš„é‡æ„æ–¹æ¡ˆï¼Œè§£å†³å½“å‰ RefinementAgent å’Œ ModifyAgent é€»è¾‘é‡å¤çš„é—®é¢˜ã€‚

## ğŸ”´ å½“å‰è®¾è®¡é—®é¢˜

### 1. é€»è¾‘é‡å¤

**RefinementAgent**ï¼š
- åœ¨ç« èŠ‚åˆ›å»ºæ—¶è‡ªåŠ¨æ‰§è¡Œ
- é‡å†™æ•´ä¸ª Section å¯¹è±¡
- ä½¿ç”¨å†…éƒ¨çš„ Agent è¿›è¡Œ AI æ¨ç†
- è¿”å›å®Œæ•´çš„ä¼˜åŒ–åçš„ Section

**ModifyAgent**ï¼š
- åœ¨ç”¨æˆ·ä¿®æ”¹æ—¶ä½¿ç”¨
- æ ¹æ®ç”¨æˆ·è¦æ±‚ä¿®æ”¹ç‰¹å®šå†…å®¹
- ä½¿ç”¨å†…éƒ¨çš„ Agent è¿›è¡Œ AI æ¨ç†
- è¿”å›ä¿®æ”¹åçš„å†…å®¹ç‰‡æ®µ

**é—®é¢˜**ï¼šä¸¤è€…éƒ½åœ¨åšå†…å®¹ä¿®æ”¹ï¼Œé€»è¾‘é‡å¤ï¼Œç»´æŠ¤æˆæœ¬é«˜ã€‚

### 2. æ•ˆç‡é—®é¢˜

**å½“å‰æµç¨‹**ï¼š
- RefinementAgent é‡å†™æ•´ä¸ª Section
- å³ä½¿å†…å®¹å·²ç»å¾ˆå¥½ï¼Œä¹Ÿä¼šå…¨éƒ¨é‡å†™
- æµªè´¹è®¡ç®—èµ„æº

**é—®é¢˜**ï¼šåº”è¯¥åªä¿®æ”¹æœ‰é—®é¢˜çš„åœ°æ–¹ï¼Œè€Œä¸æ˜¯å…¨éƒ¨é‡å†™ã€‚

### 3. æ¶æ„ä¸ä¸€è‡´

**å½“å‰æµç¨‹**ï¼š
- RefinementAgent åœ¨ SectionCreator ä¸­ç›´æ¥è°ƒç”¨
- ModifyAgent é€šè¿‡å·¥å…·ç³»ç»Ÿè°ƒç”¨
- ä¸¤å¥—ä¸åŒçš„è°ƒç”¨æ–¹å¼

**é—®é¢˜**ï¼šåº”è¯¥ç»Ÿä¸€ä½¿ç”¨å·¥å…·ç³»ç»Ÿï¼Œä¿æŒæ¶æ„ä¸€è‡´æ€§ã€‚

## âœ… é‡æ„æ–¹æ¡ˆ

### æ ¸å¿ƒæ€æƒ³

1. **è¯„ä¼°ä¸ä¿®æ”¹åˆ†ç¦»**ï¼šåˆ›å»ºè¯„ä¼° Agentï¼Œåªè¯†åˆ«é—®é¢˜ï¼Œä¸ä¿®æ”¹å†…å®¹
2. **ç»Ÿä¸€ä½¿ç”¨ Modify Tools**ï¼šæ‰€æœ‰ä¿®æ”¹éƒ½é€šè¿‡ `modify_by_id` å·¥å…·
3. **åªä¿®æ”¹æœ‰é—®é¢˜çš„åœ°æ–¹**ï¼šè¯„ä¼° Agent è¯†åˆ«å…·ä½“é—®é¢˜ï¼ŒNotebookAgent å¹¶è¡Œä¿®å¤
4. **æ¶æ„ç»Ÿä¸€**ï¼šé€šè¿‡ NotebookAgent çš„å·¥å…·ç³»ç»Ÿç»Ÿä¸€å¤„ç†

### æ–°æ¶æ„è®¾è®¡

```
ç« èŠ‚å†…å®¹åˆ›å»ºå®Œæˆ
    â†“
åˆ›å»ºè¯„ä¼° Agent (EvaluationAgent)
    â†“
è¯„ä¼° Agent è¯„ä¼°æ‰€æœ‰ç« èŠ‚å†…å®¹
    â†“
è¿”å›é—®é¢˜åˆ—è¡¨ï¼š
{
  "section_1": {
    "exercise_1": "ç¼ºå°‘é€‰é¡¹ï¼Œéœ€è¦è¡¥å……4ä¸ªé€‰é¡¹",
    "proof_1": "æ­¥éª¤ä¸å®Œæ•´ï¼Œç¼ºå°‘ä¸­é—´è®¡ç®—è¿‡ç¨‹",
    "definition_1": "å®šä¹‰ä¸å¤Ÿæ¸…æ™°"
  },
  "section_2": {
    "example_1": "ç¼ºå°‘ç­”æ¡ˆ"
  }
}
    â†“
å‘é€è¯„ä¼°ç»“æœç»™ NotebookAgent (send_message)
    â†“
NotebookAgent æ¥æ”¶æ¶ˆæ¯ï¼Œè¯†åˆ«ä¸ºè¯„ä¼°ç»“æœ
    â†“
å¹¶è¡Œè°ƒç”¨ modify_by_id ä¿®å¤é—®é¢˜ï¼š
  - modify_by_id(content_id="exercise_1", operation_type="update", ...)
  - modify_by_id(content_id="proof_1", operation_type="update", ...)
  - modify_by_id(content_id="definition_1", operation_type="update", ...)
    â†“
æ‰€æœ‰é—®é¢˜ä¿®å¤å®Œæˆ
```

## ğŸ¯ è¯¦ç»†è®¾è®¡

### 1. è¯„ä¼° Agent (EvaluationAgent)

**ä½ç½®**ï¼š`backend/tools/agent_as_tools/evaluation_agents/ContentEvaluationAgent.py`

**åŠŸèƒ½**ï¼š
- è¯„ä¼°ç« èŠ‚å†…å®¹çš„è´¨é‡
- è¯†åˆ«å…·ä½“é—®é¢˜ï¼ˆå¦‚ï¼šç¼ºå°‘é€‰é¡¹ã€æ­¥éª¤ä¸å®Œæ•´ã€å®šä¹‰ä¸æ¸…æ™°ç­‰ï¼‰
- è¿”å›é—®é¢˜åˆ—è¡¨ï¼Œä¸ä¿®æ”¹å†…å®¹

**è¾“å…¥**ï¼š
- `sections`ï¼šæ‰€æœ‰ç« èŠ‚çš„å­—å…¸
- `outline`ï¼šç¬”è®°æœ¬å¤§çº²

**è¾“å‡º**ï¼š
```python
{
  "section_title_1": {
    "field_id_1": "é—®é¢˜æè¿°1",
    "field_id_2": "é—®é¢˜æè¿°2"
  },
  "section_title_2": {
    "field_id_3": "é—®é¢˜æè¿°3"
  }
}
```

**å®ç°**ï¼š
```python
class ContentEvaluationAgent(Agent):
    """å†…å®¹è¯„ä¼° Agent - åªè¯†åˆ«é—®é¢˜ï¼Œä¸ä¿®æ”¹å†…å®¹"""
    
    def __init__(self, sections: Dict[str, Section], outline: Outline):
        instructions = """
        ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å†…å®¹è´¨é‡è¯„ä¼°ä¸“å®¶ã€‚ä½ çš„ä»»åŠ¡æ˜¯è¯„ä¼°ç« èŠ‚å†…å®¹çš„è´¨é‡ï¼Œè¯†åˆ«å…·ä½“é—®é¢˜ã€‚
        
        è¯„ä¼°æ ‡å‡†ï¼š
        1. ç»ƒä¹ é¢˜ï¼šæ˜¯å¦æœ‰å®Œæ•´çš„é€‰é¡¹ã€ç­”æ¡ˆã€è§£é‡Š
        2. è¯æ˜ï¼šæ˜¯å¦æœ‰è¯¦ç»†çš„æ­¥éª¤ã€å…¬å¼å¼•ç”¨ã€è®¡ç®—è¿‡ç¨‹
        3. å®šä¹‰ï¼šæ˜¯å¦æ¸…æ™°ã€å‡†ç¡®
        4. ä¾‹å­ï¼šæ˜¯å¦æœ‰å®Œæ•´çš„è§£ç­”
        
        è¾“å‡ºæ ¼å¼ï¼š
        è¿”å›é—®é¢˜åˆ—è¡¨ï¼Œæ ¼å¼ä¸ºï¼š
        {
          "section_title": {
            "field_id": "é—®é¢˜æè¿°"
          }
        }
        
        åªè¿”å›æœ‰é—®é¢˜çš„åœ°æ–¹ï¼Œå¦‚æœå†…å®¹å·²ç»å¾ˆå¥½ï¼Œä¸è¦è¿”å›ã€‚
        """
        # ...
```

### 2. NotebookAgent çš„å·¥å…·å¢å¼º

**æ–°å¢å·¥å…·**ï¼š`fix_content_issues` (Function Tool)

**åŠŸèƒ½**ï¼š
- æ¥æ”¶è¯„ä¼°ç»“æœ
- å¹¶è¡Œè°ƒç”¨ `modify_by_id` ä¿®å¤é—®é¢˜
- ä½¿ç”¨ ModifyAgent ç”Ÿæˆæ–°å†…å®¹ï¼ˆå¦‚æœéœ€è¦ï¼‰

**å®ç°**ï¼š
```python
@function_tool
def fix_content_issues(issues: str) -> str:
    """æ ¹æ®è¯„ä¼°ç»“æœä¿®å¤å†…å®¹é—®é¢˜
    
    Args:
        issues: è¯„ä¼°ç»“æœï¼ˆJSONå­—ç¬¦ä¸²æ ¼å¼ï¼‰
        
    Returns:
        ä¿®å¤ç»“æœä¿¡æ¯
    """
    # 1. è§£æé—®é¢˜åˆ—è¡¨
    issues_dict = json.loads(issues)
    
    # 2. å¹¶è¡Œä¿®å¤é—®é¢˜
    tasks = []
    for section_title, section_issues in issues_dict.items():
        for field_id, problem_description in section_issues.items():
            # è·å–å½“å‰å†…å®¹
            current_content = get_content_by_id(field_id)
            
            # æ ¹æ®é—®é¢˜ç±»å‹é€‰æ‹© ModifyAgent
            if "exercise" in field_id or "example" in field_id:
                modify_agent = ExerciseModifyAgent()
            elif "proof" in field_id:
                modify_agent = ProofModifyAgent()  # éœ€è¦åˆ›å»º
            elif "definition" in field_id:
                modify_agent = DefinitionModifyAgent()
            else:
                continue
            
            # ç”Ÿæˆä¿®å¤åçš„å†…å®¹
            task = asyncio.create_task(
                fix_single_issue(
                    modify_agent,
                    current_content,
                    problem_description,
                    field_id
                )
            )
            tasks.append(task)
    
    # 3. ç­‰å¾…æ‰€æœ‰ä¿®å¤å®Œæˆ
    results = await asyncio.gather(*tasks)
    
    return f"å·²ä¿®å¤ {len(results)} ä¸ªé—®é¢˜"
```

### 3. ä¿®æ”¹ SectionCreator

**å½“å‰**ï¼š
```python
# ç”Ÿæˆç« èŠ‚
section_data = await section_agent.generate()

# è‡ªåŠ¨ä¼˜åŒ–ï¼ˆé‡å†™æ•´ä¸ª Sectionï¼‰
orchestrator = RefinementOrchestrator(...)
section_data = await orchestrator.refine_all()
```

**é‡æ„å**ï¼š
```python
# ç”Ÿæˆç« èŠ‚
section_data = await section_agent.generate()

# ä¸åœ¨è¿™é‡Œä¼˜åŒ–ï¼Œç›´æ¥è¿”å›
# ä¼˜åŒ–å°†åœ¨ NotebookAgent åˆ›å»ºåç»Ÿä¸€è¿›è¡Œ
return section_data
```

### 4. ä¿®æ”¹ NotebookCreator

**åœ¨åˆ›å»º NotebookAgent å**ï¼š
```python
# åˆ›å»º NotebookAgent
notebook_agent = NoteBookAgent(...)

# è¯„ä¼°å†…å®¹
evaluation_agent = ContentEvaluationAgent(
    sections=notebook_agent.sections,
    outline=notebook_agent.outline
)
issues = await evaluation_agent.evaluate()

# å¦‚æœæœ‰é—®é¢˜ï¼Œå‘é€ç»™ NotebookAgent ä¿®å¤
if issues:
    await notebook_agent.receive_message(
        f"è¯„ä¼°å‘ç°ä»¥ä¸‹é—®é¢˜ï¼Œè¯·ä¿®å¤ï¼š\n{json.dumps(issues, ensure_ascii=False)}"
    )
```

## ğŸ“Š å®Œæ•´æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ NotebookCreator â”‚
â”‚ åˆ›å»ºæ‰€æœ‰ç« èŠ‚     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åˆ›å»º NotebookAgentâ”‚
â”‚ (åŒ…å«æ‰€æœ‰ç« èŠ‚)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ContentEvaluationâ”‚
â”‚ Agent            â”‚
â”‚                 â”‚
â”‚ è¯„ä¼°æ‰€æœ‰ç« èŠ‚å†…å®¹ â”‚
â”‚ è¯†åˆ«å…·ä½“é—®é¢˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¿”å›é—®é¢˜åˆ—è¡¨     â”‚
â”‚ {                â”‚
â”‚   "section_1": { â”‚
â”‚     "field_1":   â”‚
â”‚     "é—®é¢˜æè¿°"    â”‚
â”‚   }              â”‚
â”‚ }                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ send_message     â”‚
â”‚ å‘é€ç»™ NotebookAgentâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ NotebookAgent   â”‚
â”‚                 â”‚
â”‚ 1. æ¥æ”¶è¯„ä¼°ç»“æœ  â”‚
â”‚ 2. è§£æé—®é¢˜åˆ—è¡¨  â”‚
â”‚ 3. å¹¶è¡Œè°ƒç”¨      â”‚
â”‚    modify_by_id â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                 â”‚
         â–¼                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ModifyAgent     â”‚  â”‚ ModifyAgent     â”‚
â”‚ (ç”Ÿæˆæ–°å†…å®¹)     â”‚  â”‚ (ç”Ÿæˆæ–°å†…å®¹)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                    â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ modify_by_id     â”‚
         â”‚ (æ‰§è¡Œä¿®æ”¹)       â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ’¡ é‡æ„çš„ä¼˜åŠ¿

1. **æ¶ˆé™¤é‡å¤é€»è¾‘**ï¼šç»Ÿä¸€ä½¿ç”¨ ModifyAgent å’Œ modify_by_id
2. **æé«˜æ•ˆç‡**ï¼šåªä¿®æ”¹æœ‰é—®é¢˜çš„åœ°æ–¹ï¼Œä¸å…¨éƒ¨é‡å†™
3. **æ¶æ„ç»Ÿä¸€**ï¼šé€šè¿‡ NotebookAgent çš„å·¥å…·ç³»ç»Ÿç»Ÿä¸€å¤„ç†
4. **æ›´çµæ´»**ï¼šå¯ä»¥æ‰‹åŠ¨è§¦å‘è¯„ä¼°å’Œä¿®å¤
5. **æ›´æ˜“ç»´æŠ¤**ï¼šä¿®æ”¹é€»è¾‘é›†ä¸­åœ¨ä¸€å¤„

## ğŸ”„ è¿ç§»æ­¥éª¤

### æ­¥éª¤ 1ï¼šåˆ›å»ºè¯„ä¼° Agent

1. åˆ›å»º `ContentEvaluationAgent`
2. å®ç°è¯„ä¼°é€»è¾‘
3. æ³¨å†Œä¸º Agent as Toolï¼ˆå¯é€‰ï¼Œç”¨äºæ‰‹åŠ¨è¯„ä¼°ï¼‰

### æ­¥éª¤ 2ï¼šå¢å¼º NotebookAgent

1. æ·»åŠ  `fix_content_issues` å·¥å…·
2. æ›´æ–° promptï¼Œè¯´æ˜å¦‚ä½•å¤„ç†è¯„ä¼°ç»“æœ
3. å®ç°å¹¶è¡Œä¿®å¤é€»è¾‘

### æ­¥éª¤ 3ï¼šä¿®æ”¹åˆ›å»ºæµç¨‹

1. ç§»é™¤ `SectionCreator` ä¸­çš„ `RefinementOrchestrator` è°ƒç”¨
2. åœ¨ `NotebookCreator` åˆ›å»º NotebookAgent åæ·»åŠ è¯„ä¼°æ­¥éª¤
3. å‘é€è¯„ä¼°ç»“æœç»™ NotebookAgent

### æ­¥éª¤ 4ï¼šæ¸…ç†æ—§ä»£ç 

1. åˆ é™¤ `RefinementOrchestrator`
2. åˆ é™¤ `ExerciseRefinementAgent` å’Œ `ProofRefinementAgent`ï¼ˆæˆ–ä¿ç•™ç”¨äºå…¶ä»–åœºæ™¯ï¼‰
3. æ›´æ–°ç›¸å…³æ–‡æ¡£

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **è¯„ä¼°å‡†ç¡®æ€§**ï¼šè¯„ä¼° Agent éœ€è¦å‡†ç¡®è¯†åˆ«é—®é¢˜ï¼Œé¿å…è¯¯æŠ¥
2. **ä¿®å¤ç­–ç•¥**ï¼šéœ€è¦æ ¹æ®é—®é¢˜ç±»å‹é€‰æ‹©åˆé€‚çš„ ModifyAgent
3. **å¹¶è¡Œå¤„ç†**ï¼šæ³¨æ„å¹¶å‘æ§åˆ¶ï¼Œé¿å…ä¿®æ”¹å†²çª
4. **é”™è¯¯å¤„ç†**ï¼šä¿®å¤å¤±è´¥æ—¶çš„å›æ»šç­–ç•¥

## ğŸ¯ æœªæ¥æ‰©å±•

1. **å¢é‡è¯„ä¼°**ï¼šåªè¯„ä¼°æ–°åˆ›å»ºæˆ–ä¿®æ”¹çš„å†…å®¹
2. **è¯„ä¼°ç¼“å­˜**ï¼šç¼“å­˜è¯„ä¼°ç»“æœï¼Œé¿å…é‡å¤è¯„ä¼°
3. **è‡ªå®šä¹‰è¯„ä¼°æ ‡å‡†**ï¼šå…è®¸ç”¨æˆ·è‡ªå®šä¹‰è¯„ä¼°æ ‡å‡†
4. **è¯„ä¼°æŠ¥å‘Š**ï¼šç”Ÿæˆè¯¦ç»†çš„è¯„ä¼°æŠ¥å‘Šä¾›ç”¨æˆ·æŸ¥çœ‹


