# 工具使用说明动态生成实现总结

## 概述

实现了工具使用说明的动态生成系统，Agent 的 instructions 不再需要手动编写工具使用说明，而是从工具元数据中自动生成。

## 实现的功能

### 1. 工具使用说明生成器 (`backend/tools/tool_usage_generator.py`)

创建了 `tool_usage_generator.py` 模块，包含以下功能：

- **`generate_tool_usage_section(tool_ids, agent_instance)`**: 根据工具 ID 列表生成格式化的工具使用说明
- **`generate_tools_usage_for_agent(agent_instance)`**: 为特定 Agent 实例生成其可用工具的使用说明
- **`_format_tool_usage(metadata, index)`**: 格式化单个工具的使用说明

生成的说明包括：
- 工具名称和描述
- 用途说明
- 调用方法（Python 函数签名）
- 输入参数（类型、是否必需、描述）
- 输出类型和说明
- Agent as Tool 的特殊说明

### 2. Prompt 加载器增强 (`backend/prompts/prompt_loader.py`)

修改了 `load_prompt()` 函数，新增参数：
- `agent_instance`: Agent 实例（用于生成工具使用说明）
- `tool_ids`: 工具 ID 列表（用于生成工具使用说明）

当模板中包含 `{tools_usage}` 占位符时，会自动生成工具使用说明并替换占位符。

### 3. Prompt 模板更新

更新了所有 Agent 的 prompt 模板文件：

- **`backend/prompts/master_agent.md`**: 用 `{tools_usage}` 占位符替换了手动编写的工具使用说明
- **`backend/prompts/top_level_agent.md`**: 用 `{tools_usage}` 占位符替换了手动编写的工具使用说明
- **`backend/prompts/notebook_agent.md`**: 用 `{tools_usage}` 占位符替换了手动编写的工具使用说明

### 4. Agent 初始化更新

更新了所有 Agent 类的初始化代码，确保在创建 tools 后更新 instructions：

- **`backend/agent/MasterAgent.py`**: 在创建 tools 后，使用 `tool_ids` 参数调用 `load_prompt()` 生成包含工具使用说明的 instructions
- **`backend/agent/TopLevelAgent.py`**: 在创建 tools 后，使用 `tool_ids` 参数调用 `load_prompt()` 生成包含工具使用说明的 instructions
- **`backend/agent/NoteBookAgent.py`**: 在创建 tools 后，使用 `tool_ids` 参数调用 `load_prompt()` 生成包含工具使用说明的 instructions

### 5. 默认 Instructions 更新 (`backend/utils/default_instructions.py`)

更新了 `get_default_instructions()` 函数，为每种 Agent 类型指定默认的 `tool_ids`，确保在获取默认 instructions 时也能生成工具使用说明。

### 6. 前端更新

更新了前端组件以更好地展示工具调用方法：

- **`frontend/src/components/ToolCard.jsx`**: 
  - 添加了"调用方法"部分，显示格式化的函数签名
  - 使用等宽字体显示调用方法，更清晰易读

- **`frontend/src/pages/ToolsPage.jsx`**: 
  - 更新了页面标题和描述，强调工具调用方法的展示

## 工作流程

1. **工具注册时**：
   - 工具通过 `@register_function_tool` 或 `register_agent_as_tool()` 注册
   - 工具元数据（包括 input_params、output_type 等）存储在 ToolRegistry 中

2. **Agent 初始化时**：
   - Agent 创建 tools
   - 调用 `load_prompt()` 时传入 `tool_ids` 参数
   - `load_prompt()` 检测到 `{tools_usage}` 占位符
   - 调用 `generate_tool_usage_section()` 生成工具使用说明
   - 替换占位符，生成完整的 instructions

3. **前端展示时**：
   - ToolsPage 显示所有工具
   - ToolCard 显示每个工具的详细信息，包括调用方法
   - 用户可以查看工具的输入参数、输出类型和调用方法

## 优势

1. **自动化**：不再需要手动编写和维护工具使用说明
2. **一致性**：所有工具的使用说明格式统一
3. **准确性**：直接从工具元数据生成，确保与实际情况一致
4. **可维护性**：修改工具元数据时，使用说明自动更新
5. **前端友好**：前端可以清晰地展示工具调用方法

## 示例

### 生成的工具使用说明格式

```markdown
### 1. send_message 工具
向指定ID的agent发送消息

**用途**：用于agent之间的通信，允许一个agent向另一个agent发送消息并获取响应

**调用方法**：
```python
send_message(id, message)
```

**输入参数**：
- `id` (str)（必需）：Agent ID
- `message` (str)（必需）：要发送的消息

**输出类型**：`str`

**输出说明**：返回目标agent处理消息后的完整响应文本。如果agent执行成功，返回agent的执行结果；如果加载agent失败，返回错误信息；如果执行过程中出现异常，返回错误信息
```

### 前端显示

ToolCard 组件会显示：
- 工具名称和描述
- 调用方法（格式化的函数签名）
- 输入参数列表（类型、是否必需、描述）
- 输出类型和说明

## 注意事项

1. **工具元数据完整性**：确保所有工具都正确注册了完整的元数据（input_params、output_type、output_description 等）

2. **占位符位置**：Prompt 模板中的 `{tools_usage}` 占位符应该放在"工具使用"章节中

3. **Agent 类型特定工具**：不同 Agent 类型有不同的默认工具列表，在 `default_instructions.py` 中定义

4. **向后兼容**：如果模板中没有 `{tools_usage}` 占位符，系统会正常工作，只是不会生成工具使用说明

## 未来改进

1. **工具使用示例**：可以在工具元数据中添加使用示例，自动生成到使用说明中
2. **多语言支持**：可以根据需要支持多语言的工具使用说明
3. **工具版本管理**：当工具版本更新时，可以自动更新使用说明
4. **交互式文档**：前端可以添加"复制调用方法"按钮，方便用户使用

