# 笔记本创建系统设计说明

## 概述

新的笔记本创建系统支持4种不同的创建场景，**统一采用"先生成大纲，用户确认后再生成内容"的流程**。通过意图提取Agent自动识别用户需求，并选择合适的创建策略。

## 核心设计理念

**所有场景统一流程**：
1. **第一步**：生成大纲，让用户确认
2. **第二步**：用户确认后，根据意图选择合适的策略生成内容

这样设计的好处：
- 用户可以在生成大量内容之前确认方向是否正确
- 避免生成不符合用户期望的内容
- 提供更好的用户体验和可控性

## 架构设计

### 核心组件

1. **IntentExtractionAgent** (`backend/agent/specialized/IntentExtractionAgent.py`)
   - 分析用户请求和文件内容
   - 提取创建意图和相关信息
   - 输出 `NotebookCreationIntent` 对象

2. **NotebookCreationRouter** (`backend/agent/specialized/NotebookCreationRouter.py`)
   - `generate_outline()`: 统一的大纲生成方法（所有场景）
   - `route_and_create()`: 根据已确认的大纲和意图路由到合适的创建策略

3. **NotebookCreationStrategies** (`backend/agent/specialized/NotebookCreationStrategies.py`)
   - 实现4种不同的创建策略：
     - `create_full_content_notebook`: 丰满内容策略
     - `create_enhanced_notebook`: 内容增强策略
     - `create_knowledge_base_notebook`: 知识库策略
     - `create_outline_first_notebook`: 大纲优先策略
   - **所有策略都接受已确认的outline作为参数**

### 数据模型

**NotebookCreationIntent** (`backend/agent/specialized/NotebookModels.py`)
- `intent_type`: 意图类型（full_content, enhancement, knowledge_base, outline_first）
- `file_path`: 文件路径（可选）
- `user_description`: 用户描述
- `topic_or_theme`: 主题（用于outline_first）
- `content_richness`: 内容丰满度（rich/sparse）
- `requires_exercises`: 是否需要练习题
- `additional_requirements`: 额外要求

## 四种创建场景

### 1. Full Content（丰满内容）
- **适用场景**: 上传了内容丰满的笔记，包含完整的定义、例子、证明、练习题等
- **大纲生成**: 从文件中提取内容，生成学习大纲
- **内容生成**: 保持原文档的核心内容，主要进行格式化和轻微优化

### 2. Enhancement（内容增强）
- **适用场景**: 上传了内容稀疏的笔记/PPT，只有概念名称或简要描述
- **大纲生成**: 从文件中识别关键概念，扩展出完整的学习大纲
- **内容生成**: 主动补充和扩展内容，使内容达到完整学习材料的标准

### 3. Knowledge Base（知识库）
- **适用场景**: 上传了论文、条例、生活内容、实时资讯等，只需要记录知识，不需要练习题
- **大纲生成**: 生成知识库结构大纲（不包含学习元素）
- **内容生成**: 以知识记录为主，不包含练习题

### 4. Outline First（大纲优先）
- **适用场景**: 用户只提供了主题描述（如"创建一个关于Python的笔记"），没有上传文件
- **大纲生成**: 从主题生成学习大纲
- **内容生成**: 根据大纲和主题生成完整内容

## 使用方式

### 标准流程（推荐）

```python
from backend.tools.notebook_creator_tool import (
    generate_outline_for_confirmation,
    create_notebook_agent
)

# 第一步：生成大纲
outline, outline_info = await generate_outline_for_confirmation(
    user_request="请根据这个文件创建笔记本",
    file_path="/path/to/file.md"
)

# 展示大纲给用户确认
print(outline_info)

# 第二步：用户确认后，使用大纲创建笔记本
notebook, message = await create_notebook_agent(
    user_request="请根据这个文件创建笔记本",
    confirmed_outline=outline,
    file_path="/path/to/file.md",
    parent_agent_id=parent_id,
    DB_PATH=db_path
)
```

### 使用MasterAgent的工具

MasterAgent的 `create_notebook` 工具会：
1. 先生成大纲并返回给用户确认
2. 用户确认后，可以再次调用工具（传入确认的大纲）来创建笔记本

**注意**：当前实现中，工具只完成第一步（生成大纲）。确认后的创建需要在用户交互层面处理。

### 向后兼容的方式

```python
from backend.tools.notebook_creator_tool import create_notebook_agent_from_file

# 这个函数会自动完成两步：生成大纲（自动确认）-> 创建内容
# 适用于不需要用户确认的场景
notebook, message = await create_notebook_agent_from_file(
    file_path="/path/to/file.md",
    parent_agent_id=parent_id,
    DB_PATH=db_path
)
```

## 意图识别逻辑

IntentExtractionAgent通过分析以下信息来确定意图：

1. **是否有文件**: 
   - 有文件 → full_content, enhancement, 或 knowledge_base
   - 无文件 → outline_first

2. **内容丰满度**:
   - 如果文件内容包含完整的定义、例子、证明等 → full_content
   - 如果文件内容稀疏，只有概念或大纲 → enhancement

3. **用户描述关键词**:
   - "不需要练习题"、"知识库"、"记住" → knowledge_base
   - "补充"、"完善"、"增强" → enhancement
   - "创建笔记"、"关于XX的笔记" → outline_first（如果没有文件）

4. **文件类型和内容**:
   - 论文、条例等 → knowledge_base
   - PPT、简要笔记 → enhancement
   - 完整的课程笔记 → full_content

## 大纲生成逻辑

`NotebookCreationRouter.generate_outline()` 根据意图类型选择不同的大纲生成方式：

1. **knowledge_base**: 使用专门的KnowledgeBaseOutlineAgent，生成知识库结构
2. **有文件的其他场景**: 使用OutlineMakerAgent，从文件生成学习大纲
3. **无文件（outline_first）**: 使用TopicOutlineAgent，从主题生成学习大纲

## 系统优势

1. **统一流程**: 所有场景都先确认大纲，提供一致的用户体验
2. **用户可控**: 用户可以在生成内容前确认方向，避免浪费资源
3. **智能路由**: 自动识别用户意图，无需手动指定策略
4. **灵活扩展**: 易于添加新的创建策略
5. **向后兼容**: 保留原有接口，不影响现有代码
6. **代码复用**: 共享通用的创建逻辑，减少重复代码

## 文件结构

```
backend/agent/specialized/
├── IntentExtractionAgent.py          # 意图提取Agent
├── NotebookCreationRouter.py         # 创建路由（统一大纲生成 + 策略路由）
├── NotebookCreationStrategies.py     # 创建策略实现（都接受已确认的大纲）
├── NotebookModels.py                 # 数据模型（包含NotebookCreationIntent）
└── NoteBookCreator.py                # 原有的创建逻辑（被策略复用）

backend/tools/
├── notebook_creator_tool.py          # 创建工具（generate_outline_for_confirmation + create_notebook_agent）
└── agent_tools.py                    # Agent工具（create_notebook工具生成大纲）
```

## 未来扩展

可以考虑添加：

1. **大纲修改**: 允许用户在大纲确认阶段修改大纲内容
2. **用户偏好记忆**: 记录用户的使用习惯，优化意图识别
3. **策略参数化**: 允许用户自定义策略参数（如练习题数量）
4. **批量创建**: 支持一次处理多个文件
5. **进度反馈**: 提供创建进度的实时反馈
6. **模板系统**: 支持用户自定义笔记本模板
